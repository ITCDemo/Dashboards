<html>
<head>

    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script src="https://d3js.org/topojson.v0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/deepthiyathiender/Dendograms/master/d3.tip.v0.6.3.js"></script>

</head>

<body style="background-color: #000">

<!-- ***********   Global variables   ************ -->
<script>
    
    var regionFilter = -1;
    var countryFilter = -1;
    var ratingFilter = -1;
    var sectorFilter = -1;

    var SectoRatingMap = {
        Sector: {
            0: "SEC_1",
            1: "SEC_2",
            2: "SEC_3",
            3: "SEC_5",
            4: "SEC_6",
            5: "SEC_7",
            6: "SEC_8",
            7: "SEC_9",
            8: "SEC_11"
        },
        Rating: {
            0: "AAA",
            1: "AA",
            2: "A",
            3: "BBB",
            4: "BB",
            5: "B",
            6: "CCC",
            7: "CC",
            8: "C",
            9: "D"
        },
        SectorID: {
            "Energy": "SEC_1",
            "Materials": "SEC_2",
            "Industrials": "SEC_3",
            "Consumer Staples": "SEC_5",
            "Health Care": "SEC_6",
            "Financials": "SEC_7",
            "Information Tech": "SEC_8",
            "Telecom Services": "SEC_9",
            "Sovereign": "SEC_11"
        },
        SectorName: {
            "SEC_1": "Energy",
            "SEC_2": "Materials",
            "SEC_3": "Industrials",
            "SEC_5": "Consumer Staples",
            "SEC_6": "Health Care",
            "SEC_7": "Financials",
            "SEC_8": "Information Tech",
            "SEC_9": "Telecom Services",
            "SEC_11": "Sovereign"
        }

    };

    var regionLatLong = {
        "NAMR": [-100.89, 41.17],
        "SAMR": [-60.82, -12.65],
        "MENA": [42.18, 34.22],
        "APAC": [86.13, 38.74],
        "EURO": [8.43, 48.15]
    };


</script>

<script>

    // IIFE to enable reading from CSV file in local machine

    (function (element, callback) {
        var uploader = document.getElementById(element);
        var reader = new FileReader();

        reader.onload = function (e) {
            var contents = e.target.result;
            callback(contents);
        };

        uploader.addEventListener("change", handleFiles, false);

        function handleFiles() {
            var file = this.files[0];
            reader.readAsText(file);
        }
    })("uploader", function (csv) {

        // Array of objects from csv file. Each object represents a line in the csv
        var data = d3.csv.parse(csv);
        dataCopy = data;
        DrawCharts(data);
    });


    /*
     This is the most important function
     It creates all the datastructures which will be used to display the charts
     Each time a new csv is loaded or when the data is filtered, this
     function is called to create a fresh copy of all the data datastructures
     The data input to this function can either be the array from the csv
     or data after the filtering process
     */
    function DrawCharts(data) {

        // Each time the charts are refreshed, the Region radio button is checked
        $('input[name=region][value=' + 'Region' + ']').prop('checked', true);


        //reset datastructures
        counterpartyExp = {};
        regionMasterMap = {};
        regionMap = [];
        countryMapMarkers = [];
        ratingMap = {};
        countryMap = {};

        for (var i = 0; i < data.length; i++) {

            /* convert string to integer
             For example: converts string 1,000,000 to integer 1000000*/
            var exp = parseInt(data[i]["Market Value"].replace(/,/g, ""));


            if (!(data[i]["Counterparty"] in counterpartyExp)) {
                counterpartyExp[data[i]["Counterparty"]] = exp
            }
            else {
                var existingValue = counterpartyExp[data[i]["Counterparty"]];
                counterpartyExp[data[i]["Counterparty"]] = exp + existingValue;
            }

            var instrument = data[i]["Instrument"];
            var region = data[i]["Region"];


            if (regionMasterMap[data[i]["Region"]] == undefined) {
                regionMasterMap[region] = {
                    [instrument]: exp
                }
            }
            else {
                if (regionMasterMap[data[i]["Region"]][instrument] == undefined) {
                    regionMasterMap[data[i]["Region"]][instrument] = exp
                }
                else {
                    existingExp = regionMasterMap[data[i]["Region"]][instrument];
                    regionMasterMap[data[i]["Region"]][instrument] = existingExp + exp
                }
            }

            if (instrumentMap[data[i]["Instrument"]] == undefined) {
                instrumentMap[data[i]["Instrument"]] = {};
                instrumentMap[data[i]["Instrument"]][[data[i]["Counterparty"]]] = exp
            }
            else {
                existingExp = instrumentMap[data[i]["Instrument"]][data[i]["Counterparty"]] == undefined ? 0 : instrumentMap[data[i]["Instrument"]][data[i]["Counterparty"]];
                instrumentMap[data[i]["Instrument"]][data[i]["Counterparty"]] = existingExp + exp;
            }


            if (!(data[i]["Country"] in countryMap)) {

                if (countryMap[data[i]["Country"]] == undefined) {
                    countryMap[data[i]["Country"]] = {};
                }
                countryMap[data[i]["Country"]][instrument] = parseInt(data[i]["Market Value"].replace(/,/g, ""))
            }
            else {
                if (countryMap[data[i]["Country"]] == undefined) {
                    countryMap[data[i]["Country"]] = {};
                }

                if (countryMap[data[i]["Country"]][instrument] == undefined) {
                    countryMap[data[i]["Country"]][instrument] = parseInt(data[i]["Market Value"].replace(/,/g, ""));
                }
                else {
                    var existingBondCountry = countryMap[data[i]["Country"]][instrument];
                    countryMap[data[i]["Country"]][instrument] = parseInt(data[i]["Market Value"].replace(/,/g, "")) + existingBondCountry;
                }
            }
        }

        //remove all charts, charts have to be redrawn
        d3.select('#map-canvas svg').remove();
        d3.select('.PieRating svg').remove();
        d3.select('#horizontalBar svg').remove();
        d3.select('#SectorTree svg').remove();


        // call functions to display various items on the dashboard
        DrawMap(data);
        DrawPie(data);
        HorizontalChart(counterpartyExp);
        BuildTreeMap(data);
        displayStats(data);
    }

    /*
     <input type="file"> input types will display a default button with text "Choose file"
     This default button text is determined by the browser and cant be changed ...
     To change the text of the button and style it differently, we place a fake button
     on top of the choose file button.

     The Sync function copies the path of the file chosen from the text box provided by
     <input type="file"> to a another text box
     */
    function Sync() {
        var n1 = document.getElementById('uploader');
        var n2 = document.getElementById('FakeID');
        n2.value = n1.value.replace(/^.*[\\\/]/, '');
    }


    //Function invoked when clear filters button is clicked
    function clearFilters() {

        regionFilter = -1;
        countryFilter = -1;
        sectorFilter = -1;
        ratingFilter = -1;


        //remove all overlays
        $('#bar-overlay').css({'opacity': 0, 'z-index': -1, 'height': '0px'});
        d3.select('#pie svg').remove();
        $('#ratingSector-overlay').css({'opacity': 0, 'z-index': 99, 'height': '0px'});
        d3.select('#tree svg').remove();
        d3.select('#barpieUtil svg').remove();
        $('#Sector-overlay').css({'opacity': 0, 'z-index': -1, 'height': '0px'});
        d3.select('#Sectree svg').remove();
        d3.select('#SecbarpieUtil svg').remove();

        DrawCharts(dataCopy);
    }


    // function to calculate data based on which filters are active
    // up - filtering, adding filters
    function calculateFilters() {

        $('#bar-overlay svg').remove();

        var filteredDataset = dataCopy;

        if (regionFilter != -1) {
            filteredDataset = filteredDataset.filter(function (obj) {
                if (obj["Region"] == regionFilter) {
                    return true;
                }
            });
        }

        if (countryFilter != -1) {
            filteredDataset = filteredDataset.filter(function (obj) {
                if (obj["Country"] == countryFilter) {
                    return true;
                }
            });
        }

        if (ratingFilter != -1) {
            filteredDataset = filteredDataset.filter(function (obj) {
                if (obj["Rating"] == ratingFilter) {
                    return true;
                }
            });
        }

        if (sectorFilter != -1) {
            filteredDataset = filteredDataset.filter(function (obj) {
                if (obj["Sector_ID"] == sectorFilter) {
                    return true;
                }
            });
        }

        DrawCharts(filteredDataset);

        return filteredDataset;
    }


    // Function called when filters are being closed
    // down - filtering, removing filters
    function reverseFilter(filteredDataset) {

        //display overlays if they were open before the data was filtered
        if (regionFilter != -1) {
            BarOverlayData(filteredDataset, regionFilter);
        }
        else if (countryFilter != -1) {
            BarOverlayData(filteredDataset, countryFilter);
        }

        if (ratingFilter != -1) {
            DisplayDendo(filteredDataset, "Rating");
        }

        if (sectorFilter != -1) {
            DisplayDendo(filteredDataset, "Sector");
        }
    }

    /*
     d3 bar charts need the data to be in a certain format
     This function takes the data set, and converts into
     the format needed by d3 bar charts
     and finally calls the function to draw the bar chart on the region overlay
     */
    function BarOverlayData(filteredSet, name) {
        var instrData = {};
        var exp;
        var Barset = [];

        for (var instr in filteredSet) {
            if (instrData[filteredSet[instr]["Instrument"]] == undefined) {
                instrData[filteredSet[instr]["Instrument"]] = {};
                instrData[filteredSet[instr]["Instrument"]] = parseInt(filteredSet[instr]["Market Value"].replace(/,/g, ""));
            }
            else {
                existingExp = instrData[filteredSet[instr]["Instrument"]] == undefined ? 0 : instrData[filteredSet[instr]["Instrument"]];
                instrData[filteredSet[instr]["Instrument"]] = existingExp + parseInt(filteredSet[instr]["Market Value"].replace(/,/g, ""));
            }
        }

        for (var item in instrData) {
            exp = {name: item, value: instrData[item]};
            Barset.push(exp);
        }

        drawBarRegion(Barset, name);
    }


    //This function displays the Utilization / Exposure and Utilization percentages
    function displayStats(data) {
        var CPMap = {};
        var totalExp = 0;
        var totalAlloc = 0;
        for (var i = 0; i < data.length; i++) {
            if (!(data[i]["Counterparty"] in CPMap)) {
                CPMap[data[i]["Counterparty"]] = "";
                totalAlloc = totalAlloc + parseInt(data[i]["Allocation"]);
            }

            totalExp = totalExp + parseInt(data[i]["Market Value"].replace(/,/g, ""));
        }

        $("#Utilization").html(FormatMoney(totalExp));
        $("#UtilPercent").html((totalExp / totalAlloc * 100).toFixed(2) + "%")

        if ((totalExp / totalAlloc * 100).toFixed(2) < 60) {
            $("#UtilPercent").css("border-color", "green");
            return;
        }
        else if ((totalExp / totalAlloc * 100).toFixed(2) < 80) {
            $("#UtilPercent").css("border-color", "orange");
            return;
        }
        else {
            $("#UtilPercent").css("border-color", "red");
            return;
        }
    }


    /*This function takes a big number and returns a string
     It is used to make large numbers more readable like 10K , 10M, 10B, 10T*/
    function FormatMoney(money) {
        formattedMoney = "";
        switch (money.toString().length) {
            case 4:
            case 5:
            case 6:
                formattedMoney = "$ " + (money / 1000).toFixed(1) + "K";
                break;
            case 7:
            case 8:
            case 9:
                formattedMoney = "$ " + (money / 1000000).toFixed(1) + "M";
                break;

            case 10:
            case 11:
            case 12:
                formattedMoney = "$ " + (money / 1000000000).toFixed(1) + "B";
                break;
            case 13:
            case 14:
            case 15:
                formattedMoney = "$ " + (money / 1000000000000).toFixed(1) + "T";
                break;
            default:
                formattedMoney = "$ " + money;
        }
        return formattedMoney;
    }

</script>
<script>

    //read the lat longs of all cities in the world
    //and build a hashmap, hashed by country name
    queue()
            .defer(d3.csv, "countriesLatLong.csv", function (data) {
                LatLongMap[data.country] = {
                    lat: data.lat,
                    long: data.long,
                    abr: data.abr
                }
            });

</script>
</body>
</html>