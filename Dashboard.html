<html>
<head>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script src="https://d3js.org/topojson.v0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/deepthiyathiender/Dendograms/master/d3.tip.v0.6.3.js"></script>
    <script src="regionMap.js"></script>
    <script src="BarchartOverlay.js"></script>
    <script src="PieChart.js"></script>
    <script src="HorizontalChart.js"></script>
    <script src="SmallDendogram.js"></script>
    <script src="PieOverlay.js"></script>
    <script src="TreeMap.js"></script>

    <style>
        section {
            background-color: #000;
            margin: 10px;
            position: relative;
            margin-top: 3px;
        }

        h3 {
            margin-top: 10px;
            line-height: 10px;
            position: absolute;
            z-index: 99;
        }

        #map-canvas {
            height: 300px;
            width: 600px;
        }

        .overlay {
            width: 180px;
            height: 50px;
            display: none;
            z-index: 99;
            box-sizing: border-box;
            font-size: 10px;
            line-height: 1;
            color: rgba(0, 0, 0, 0.6);
            content: "\25BC";
            position: absolute;
            text-align: center;
            padding: 12px;
            padding-top: 0;
            padding-bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            border-radius: 10px;
        }

        .mark:hover {
            cursor: hand;
        }

        .pietip {
            width: 150px;
            height: 30px;
            display: none;
            z-index: 99;
            box-sizing: border-box;
            font-size: 16px;
            line-height: 1;
            color: rgba(0, 0, 0, 0.8);
            content: "\25BC";
            position: absolute;
            text-align: center;
            padding: 12px;
            padding-top: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 10px;
            font-weight: bold;
        }

        #bar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            opacity: 0;
            z-index: -1;
            -webkit-transition: all 0.5s linear;
            -moz-transition: all 0.5s linear;
            -o-transition: all 0.5s linear;
            height: 0px;
            width: 600px;
            float: left;
        }

        #ratingSector-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            background: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            opacity: 0;
            z-index: -1;
            -webkit-transition: all 0.5s linear;
            -moz-transition: all 0.5s linear;
            -o-transition: all 0.5s linear;
            height: 0px;
            width: 620px;
            float: left;
        }

        #Sector-overlay {
            position: absolute;
            top: 20px;
            left: 30px;
            right: 0;
            bottom: 0;
            background: #000;
            background: rgba(0, 0, 0, 1);
            color: #ffffff;
            opacity: 0;
            z-index: -1;
            -webkit-transition: all 0.5s linear;
            -moz-transition: all 0.5s linear;
            -o-transition: all 0.5s linear;
            height: 0px;
            width: 540px;
            float: left;
        }

        .close {
            line-height: 12px;
            width: 18px;
            font-size: 14pt;
            margin-top: 1px;
            margin-right: 2px;
            position: absolute;
            top: 10px;
            right: 0;
            cursor: pointer;
            color: #fff;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #fff;
            shape-rendering: crispEdges;
        }

        .bar,
        .barPie {
            fill: #05739D;
        }

        .bar:hover,
        .barPie:hover {
            fill: #095DA2;
        }

        .tick {
            fill: white;
            color: #fff;
            font-size: 10px;
        }

        .x.axis path
        .x.axis line {
            display: none;
            stroke: #fff;
            shape-rendering: crispEdges;
        }

        #yaxis g text {
            fill: #fff;
            color: #fff;
            font-size: 14px;
        }

        .d3-tip {
            line-height: 1;
            font-weight: bold;
            padding: 12px;
            background: rgba(255, 255, 255, 1);
            color: #000;
            opacity: 1;
            z-index: 10000;
            border-radius: 2px;
        }

        /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {
            box-sizing: border-box;
            display: inline;
            font-size: 10px;
            width: 100%;
            line-height: 1;
            color: #fff;
            content: "\25BC";
            position: absolute;
            text-align: center;
            opacity: 1;
        }

        /* Style northward tooltips differently */
        .d3-tip.n:after {
            margin: -1px 0 0 0;
            top: 100%;
            left: 0;
        }

        form {
            position: absolute;
            right: 10px;
            top: 10px;
        }

        #xaxis .domain {
            fill: white;
            stroke: #fff;
        }

        #xaxis text, #yaxis text {
            font-size: 12px;
            fill: white;
        }

        #horizontalBar svg {
            margin-top: -15px;
            padding-left: 30px
        }

        .node {
            cursor: pointer;
        }

        .node circle {
            fill: #fff;
            stroke: #2B8CB1;
            stroke-width: 2px;
        }

        .node text {
            font: 10px sans-serif;
            fill: white;
            color: white;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 4px;
            stroke-opacity: 0.3;
        }

        .country {
            fill: #817f7b;
            stroke-linejoin: round;
        }

        #barpieUtil,
        #secbarpieutil {
            width: 230px;
            float: left;
        }

        td#sectree {
            width: 230px;
        }

        .y {
            font-size: 10px;
            fill: white;
        }

        #barpieUtil svg.shadow {
            margin-left: 40px
        }

        #secbarpieutil svg.shadow {
            margin-left: 40px
        }

        #FakeID {
            border: 0px;
            font-size: 12px;
            vertical-align: middle;
            background-color: #000;
            color: #fff;
        }

        .StyledButton {
            -moz-box-shadow: 0px 10px 12px -7px #276873;
            -webkit-box-shadow: 0px 10px 12px -7px #276873;
            box-shadow: 0px 10px 12px -7px #276873;
            background-color: #599bb3;
            border-radius: 8px;
            display: inline-block;
            cursor: pointer;
            color: #ffffff;
            font-size: 12px;
            font-weight: bold;
            padding: 0px 7px;
            text-decoration: none;
            text-shadow: 0px 1px 0px #3d768a;
            height: 30px;
            line-height: 1;
            text-align: center;
            vertical-align: middle;
        }

        .StyledButton:hover {
            background-color: #408c99;
        }

        .StyledButton:active {
            position: relative;
            top: 1px;
        }

        div.fileinputs {
            position: relative;
            margin-bottom: 30px;
        }

        div.fakefile {
            position: absolute;
            top: 0px;
            left: 0px;
            z-index: 1;
        }

        input.file {
            position: relative;
            top: 5px;
            text-align: right;
            -moz-opacity: 0;
            filter: alpha(opacity:0);
            opacity: 0;
            z-index: 2;
        }

        .treemap {
            border: solid 1px #000;
            line-height: 0.95;
            overflow: hidden;
            position: absolute;
            border-radius: 6px;
            color: #000;
        }

        .treemap div {
            padding: 6px 4%;
        }

        .treemap:hover {
            -moz-box-shadow: 0 0 10px white;
            -webkit-box-shadow: 0 0 10px white;
            box-shadow: 0 0 10px white;
            cursor: pointer;
            z-index: 99;
        }

        svg {
            background-color: #000;
        }

        form {
            color: #fff;
            position: fixed;
            top: 15px;
            left: 300px
        }

        .stats {
            border: solid 2px;
            height: 25px;
            width: 150px;
            float: left;
            margin-left: 20px;
            position: absolute;
            color: #fff;
            text-align: center;
            vertical-align: middle;
            padding-top: 8px;
            font-size: 16px;
            font-weight: bold;
        }

    </style>
</head>

<body style="background-color: #000">
<script>
    function Sync() {
        var n1 = document.getElementById('uploader');
        var n2 = document.getElementById('FakeID');
        n2.value = n1.value.replace(/^.*[\\\/]/, '');
    }
</script>
<div class="pietip"></div>

<div class="fileinputs">
    <input type="file" class="file" id="uploader" onchange="Sync()" style="height: 30px; cursor: pointer;"/>
    <div class="fakefile">
        <input id="FakeID"/>
        <input type="button" value="Refresh Data" id="FakeButton" class="StyledButton" />
    </div>
</div>
<form>
    <label><input type="radio" name="region" value="Region" checked> Region</label>
    <label><input type="radio" name="region" value="Country"> Country</label>
</form>

<!--<div class="stats" style="top: 10px; left: 500px; border-color: green;" id="Exposure"></div>-->
<div class="stats" style="top: 10px; left: 700px; border-color: #599BB3;" id="Utilization"> $0 </div>
<div class="stats" style="top: 10px; left: 900px; border-color: orange;" id="UtilPercent"> 0% </div>

<input type="button" value="Clear Filters" style="top: 10px; left:   1150px; position: absolute" class="StyledButton"
       onclick="clearFilters()"/>


<section style="float: left; height: 300px; width: 600px;">
    <div id="map-canvas">
        <div class="overlay"></div>
    </div>
    <div id="bar-overlay">
        <div id="pie" class="chart-container">

        </div>
        <div id="close" class="close"
             onclick="$('#bar-overlay').css({'opacity': 0, 'z-index': -1, 'height': '0px'}); d3.select('#pie svg').remove(); countryFilter = -1; regionFilter = -1; var filteredDataset = calculateFilters(); reverseFilter(filteredDataset);">
            &#10006;</div>
    </div>
</section>
<section style="float: left; height: 300px; width: 620px;" class="PieRating">
    <div id="ratingSector-overlay">
        <table>
            <tr>
                <td id="tree" style="width: 390px">

                </td>
                <td id="barpieUtil" style="width: 230px">

                </td>
            </tr>
        </table>
        <div id="closePie" class="close"
             onclick="$('#ratingSector-overlay').css({'opacity': 0, 'z-index': 99, 'height': '0px'}); d3.select('#tree svg').remove(); d3.select('#barpieUtil svg').remove(); ratingFilter = -1; var filteredDataset = calculateFilters(); reverseFilter(filteredDataset)">
            &#10006;</div>
    </div>
</section>
<section id="horizontalBar" style="float: left; height: 340px; width: 580px">
</section>
<section id="SectorTree" style="float: left; height: 340px; width: 600px; padding-top: 20px; padding-left: 30px">
    <div id="Sector-overlay">
        <table>
            <tr>
                <td id="Sectree" style="width: 380px">

                </td>
                <td id="SecbarpieUtil" style="width: 230px">

                </td>
            </tr>
        </table>
        <div class="close" id="closeTree"
             onclick="$('#Sector-overlay').css({'opacity': 0, 'z-index': -1, 'height': '0px'}); d3.select('#Sectree svg').remove(); d3.select('#SecbarpieUtil svg').remove(); sectorFilter = -1; var filteredDataset = calculateFilters(); reverseFilter(filteredDataset)">
            &#10006;</div>
    </div>
</section>
<script>
    upload_button("uploader", load_dataset);

    function load_dataset(csv) {
        var data = d3.csv.parse(csv);
        dataCopy = data;
        create_table(data);
    }

    function create_table(data) {

        $('input[name=region][value=' + 'Region' + ']').prop('checked', true);

        counterpartyExp = {};
        regionMasterMap = {};
        regionMap = [];
        countryMapMarkers = [];
        ratingMap = {};
        countryMap = {};
        sectorMap = {};

        var keys = d3.keys(data[0]);

        for (var i = 0; i < data.length; i++) {

            var exp = parseInt(data[i]["Market Value"].replace(/,/g, ""));

            if (!(data[i]["Counterparty"] in counterpartyExp)) {
                counterpartyExp[data[i]["Counterparty"]] = exp
            }
            else {
                var existingValue = counterpartyExp[data[i]["Counterparty"]];
                counterpartyExp[data[i]["Counterparty"]] = exp + existingValue;
            }

            var instrument = data[i]["Instrument"];
            var region = data[i]["Region"];


            if (regionMasterMap[data[i]["Region"]] == undefined) {
                regionMasterMap[region] = {
                    [instrument]: exp
                }
            }
            else {
                if (regionMasterMap[data[i]["Region"]][instrument] == undefined) {
                    regionMasterMap[data[i]["Region"]][instrument] = exp
                }
                else {
                    existingExp = regionMasterMap[data[i]["Region"]][instrument];
                    regionMasterMap[data[i]["Region"]][instrument] = existingExp + exp
                }
            }

            if (instrumentMap[data[i]["Instrument"]] == undefined) {
                instrumentMap[data[i]["Instrument"]] = {};
                instrumentMap[data[i]["Instrument"]][[data[i]["Counterparty"]]] = exp
            }
            else {
                existingExp = instrumentMap[data[i]["Instrument"]][data[i]["Counterparty"]] == undefined ? 0 : instrumentMap[data[i]["Instrument"]][data[i]["Counterparty"]];
                instrumentMap[data[i]["Instrument"]][data[i]["Counterparty"]] = existingExp + exp;
            }


            if (!(data[i]["Country"] in countryMap)) {

                if (countryMap[data[i]["Country"]] == undefined) {
                    countryMap[data[i]["Country"]] = {};
                }
                countryMap[data[i]["Country"]][instrument] = parseInt(data[i]["Market Value"].replace(/,/g, ""))
            }
            else {
                if (countryMap[data[i]["Country"]] == undefined) {
                    countryMap[data[i]["Country"]] = {};
                }

                if (countryMap[data[i]["Country"]][instrument] == undefined) {
                    countryMap[data[i]["Country"]][instrument] = parseInt(data[i]["Market Value"].replace(/,/g, ""));
                }
                else {
                    var existingBondCountry = countryMap[data[i]["Country"]][instrument];
                    countryMap[data[i]["Country"]][instrument] = parseInt(data[i]["Market Value"].replace(/,/g, "")) + existingBondCountry;
                }
            }
        }

        d3.select('#map-canvas svg').remove();
        d3.select('.PieRating svg').remove();
        d3.select('#horizontalBar svg').remove();
        d3.select('#SectorTree svg').remove();


        DrawMap(data);
        DrawPie(data);
        HorizontalChart(counterpartyExp);
        BuildTreeMap(data);
        displayStats(data);
    }

    function upload_button(el, callback) {
        var uploader = document.getElementById(el);
        var reader = new FileReader();

        reader.onload = function (e) {
            var contents = e.target.result;
            callback(contents);
        };

        uploader.addEventListener("change", handleFiles, false);

        function handleFiles() {
            var file = this.files[0];
            reader.readAsText(file);
        }
    }

    function clearFilters() {

        regionFilter = -1;
        countryFilter = -1;
        sectorFilter = -1;
        ratingFilter = -1;
        $('#bar-overlay').css({'opacity': 0, 'z-index': -1, 'height': '0px'}); d3.select('#pie svg').remove();
        $('#ratingSector-overlay').css({'opacity': 0, 'z-index': 99, 'height': '0px'}); d3.select('#tree svg').remove(); d3.select('#barpieUtil svg').remove();
        $('#Sector-overlay').css({'opacity': 0, 'z-index': -1, 'height': '0px'}); d3.select('#Sectree svg').remove(); d3.select('#SecbarpieUtil svg').remove();

        create_table(dataCopy);
    }

    function calculateFilters() {

        $('#bar-overlay svg').remove();

        var filteredDataset = dataCopy;

        if (regionFilter != -1) {
            filteredDataset = filteredDataset.filter(function (obj) {
                if (obj["Region"] == regionFilter) {
                    return true;
                }
            });
        }

        if (countryFilter != -1) {
            filteredDataset = filteredDataset.filter(function (obj) {
                if (obj["Country"] == countryFilter) {
                    return true;
                }
            });
        }

        if (ratingFilter != -1) {
            filteredDataset = filteredDataset.filter(function (obj) {
                if (obj["Rating"] == ratingFilter) {
                    return true;
                }
            });
        }

        if (sectorFilter != -1) {
            filteredDataset = filteredDataset.filter(function (obj) {
                if (obj["Sector_ID"] == sectorFilter) {
                    return true;
                }
            });
        }

        create_table(filteredDataset);

        return filteredDataset;
    }

    function reverseFilter(filteredDataset) {
        if (regionFilter != -1) {
            BarOverlayData(filteredDataset, regionFilter);
        }
        else if (countryFilter != -1) {
            BarOverlayData(filteredDataset, countryFilter);
        }

        if (ratingFilter != -1) {
            DisplayDendo(filteredDataset, "Rating");
        }

        if (sectorFilter != -1) {
            DisplayDendo(filteredDataset, "Sector");
        }
    }


    function BarOverlayData(filteredSet, name) {
        var instrData = {};
        var exp;
        var Barset = [];

        for (var instr in filteredSet) {
            if (instrData[filteredSet[instr]["Instrument"]] == undefined) {
                instrData[filteredSet[instr]["Instrument"]] = {};
                instrData[filteredSet[instr]["Instrument"]] = parseInt(filteredSet[instr]["Market Value"].replace(/,/g, ""));
            }
            else {
                existingExp = instrData[filteredSet[instr]["Instrument"]] == undefined ? 0 : instrData[filteredSet[instr]["Instrument"]];
                instrData[filteredSet[instr]["Instrument"]] = existingExp + parseInt(filteredSet[instr]["Market Value"].replace(/,/g, ""));
            }
        }

        for (var item in instrData) {
            exp = {name: item, value: instrData[item]};
            Barset.push(exp);
        }

        drawBarRegion(Barset, name);
    }

    function displayStats(data){
        var CPMap = {};
        var totalExp = 0;
        var totalAlloc = 0;
        for(var i=0; i<data.length; i++) {
            if(!(data[i]["Counterparty"] in CPMap)){
                CPMap[data[i]["Counterparty"]] = "";
                totalAlloc = totalAlloc + parseInt(data[i]["Allocation"]);
            }

            totalExp = totalExp + parseInt(data[i]["Market Value"].replace(/,/g, ""));
        }

        $("#Utilization").html(FormatMoney(totalExp));
        $("#UtilPercent").html((totalExp/totalAlloc*100).toFixed(2)+"%")

        if((totalExp/totalAlloc*100).toFixed(2) < 60){
            $("#UtilPercent").css("border-color", "green");
            return;
        }
        else if((totalExp/totalAlloc*100).toFixed(2) < 80){
            $("#UtilPercent").css("border-color", "orange");
            return;
        }
        else{
            $("#UtilPercent").css("border-color", "red");
            return;
        }
    }

    function FormatMoney(money){

        formattedMoney = "";
        switch(money.toString().length){
            case 4:
            case 5:
            case 6:
                formattedMoney = "$ "+(money/1000).toFixed(1)+ "K";
                break;
            case 7:
            case 8:
            case 9:
                formattedMoney = "$ "+(money/1000000).toFixed(1) + "M";
                break;

            case 10:
            case 11:
            case 12:
                formattedMoney = "$ "+(money/1000000000).toFixed(1) + "B";
                break;
            case 13:
            case 14:
            case 15:
                formattedMoney = "$ "+(money/1000000000000).toFixed(1) + "T";
                break;
            default:
                formattedMoney = "$ "+money;
        }
        return formattedMoney;
    }


</script>
<script>
    var regionMasterMap = {};

    var sectorMap = {};

    var regionMap = [];
    var countryMapMarkers = [];

    var counterpartyExp = {};

    var countryMap = {};

    var masterCounterparty = [];

    var LatLongMap = {};
    var regionLatLong = {};
    var instrumentMap = {};

    var dataCopy;

    var regionFilter = -1;
    var countryFilter = -1;
    var ratingFilter = -1;
    var sectorFilter = -1;

    var SectoRatingMap = {
        Sector: {
            0: "SEC_1",
            1: "SEC_2",
            2: "SEC_3",
            3: "SEC_5",
            4: "SEC_6",
            5: "SEC_7",
            6: "SEC_8",
            7: "SEC_9",
            8: "SEC_11"
        },
        Rating: {
            0: "AAA",
            1: "AA",
            2: "A",
            3: "BBB",
            4: "BB",
            5: "B",
            6: "CCC",
            7: "CC",
            8: "C",
            9: "D"
        },
        SectorID: {
            "Energy": "SEC_1",
            "Materials": "SEC_2",
            "Industrials": "SEC_3",
            "Consumer Staples": "SEC_5",
            "Health Care": "SEC_6",
            "Financials": "SEC_7",
            "Information Tech": "SEC_8",
            "Telecom Services": "SEC_9",
            "Sovereign": "SEC_11"
        },
        SectorName: {
            "SEC_1": "Energy",
            "SEC_2": "Materials",
            "SEC_3": "Industrials",
            "SEC_5": "Consumer Staples",
            "SEC_6": "Health Care",
            "SEC_7": "Financials",
            "SEC_8": "Information Tech",
            "SEC_9": "Telecom Services",
            "SEC_11": "Sovereign"
        }

    };

    queue()
            .defer(d3.csv, "countriesLatLong.csv", function (data) {
                LatLongMap[data.country] = {
                    lat: data.lat,
                    long: data.long,
                    abr: data.abr
                }
            });

    regionLatLong = {
        "NAMR": [-100.89, 41.17],
        "SAMR": [-60.82, -12.65],
        "MENA": [42.18, 34.22],
        "APAC": [86.13, 38.74],
        "EURO": [8.43, 48.15]
    };

</script>
</body>
</html>